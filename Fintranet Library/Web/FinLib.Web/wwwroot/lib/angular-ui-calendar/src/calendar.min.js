angular.module("ui.calendar",[]).constant("uiCalendarConfig",{calendars:{}}).controller("uiCalendarCtrl",["$scope","$locale",function(n,t){var u=n.eventSources,f=n.calendarWatchEvent?n.calendarWatchEvent:angular.noop,e=function(t){return function(){if(n.$root.$$phase)return t.apply(this,arguments);var i=arguments,r=this;return n.$root.$apply(function(){return t.apply(r,i)})}},o=1,i,r;this.eventFingerprint=function(n){n._id||(n._id=o++);var t=f({event:n})||"",i=moment.isMoment(n.start)?n.start.unix():n.start?moment(n.start).unix():"",r=moment.isMoment(n.end)?n.end.unix():n.end?moment(n.end).unix():"";return[n._id,n.id||"",n.title||"",n.url||"",i,r,n.allDay||"",n.className||"",t].join("")};i=1;r=1;this.sourceFingerprint=function(n){var t=""+(n.__id||(n.__id=i++)),u=angular.isObject(n)&&n.events;return u&&(t=t+"-"+(u.__id||(u.__id=r++))),t};this.allEvents=function(){return Array.prototype.concat.apply([],(u||[]).reduce(function(n,t){if(angular.isArray(t))n.push(t);else if(angular.isObject(t)&&angular.isArray(t.events)){var i=Object.keys(t).filter(function(n){return n!=="_id"&&n!=="events"});t.events.forEach(function(n){angular.extend(n,i)});n.push(t.events)}return n},[]))};this.changeWatcher=function(n,t){var i,f=function(){return((angular.isFunction(n)?n():n)||[]).reduce(function(n,i){var u=t(i);return r[u]=i,n.push(u),n},[])},u=function(n,t){var i=(t||[]).reduce(function(n,t){return n[t]=!0,n},Object.create(null));return(n||[]).filter(function(n){return!i[n]})},r={},e=function(n,f){for(var h,a={},v=u(f,n),o,s,c,l,e=0;e<v.length;e++)if(o=v[e],s=r[o],delete r[o],c=t(s),c===o)i.onRemoved(s);else{a[c]=o;i.onChanged(s)}for(l=u(n,f),e=0;e<l.length;e++)if(h=l[e],!a[h])i.onAdded(r[h])};return i={subscribe:function(n,t){n.$watch(f,function(n,i){var r=!(t&&t(n,i)===!1);r&&e(n,i)},!0)},onAdded:angular.noop,onChanged:angular.noop,onRemoved:angular.noop}};this.getFullCalendarConfig=function(n,t){var i={};return angular.extend(i,t),angular.extend(i,n),angular.forEach(i,function(n,t){typeof n=="function"&&(i[t]=e(i[t]))}),i};this.getLocaleConfig=function(n){if(!n.lang||n.useNgLocale){var i=function(n){return(Object.keys(n)||[]).reduce(function(t,i){return t.push(n[i]),t},[])},r=t.DATETIME_FORMATS;return{monthNames:i(r.MONTH),monthNamesShort:i(r.SHORTMONTH),dayNames:i(r.DAY),dayNamesShort:i(r.SHORTDAY)}}return{}}}]).directive("uiCalendar",["uiCalendarConfig",function(n){return{restrict:"A",scope:{eventSources:"=ngModel",calendarWatchEvent:"&"},controller:"uiCalendarCtrl",link:function(t,i,r,u){function l(){var h=r.uiCalendar?t.$parent.$eval(r.uiCalendar):{},o=u.getFullCalendarConfig(h,n),s=u.getLocaleConfig(o),f,i;angular.extend(s,o);e={eventSources:c};angular.extend(e,s);e.calendars=null;f={};for(i in e)i!=="eventSources"&&(f[i]=e[i]);return JSON.stringify(f)}var c=t.eventSources,o=!1,f,s=u.changeWatcher(c,u.sourceFingerprint),h=u.changeWatcher(u.allEvents,u.eventFingerprint),e=null;t.destroyCalendar=function(){f&&f.fullCalendar&&f.fullCalendar("destroy");f=r.calendar?n.calendars[r.calendar]=angular.element(i).html(""):angular.element(i).html("")};t.initCalendar=function(){f||(f=angular.element(i).html(""));f.fullCalendar(e);r.calendar&&(n.calendars[r.calendar]=f)};t.$on("$destroy",function(){t.destroyCalendar()});s.onAdded=function(t){f&&f.fullCalendar&&(f.fullCalendar(e),r.calendar&&(n.calendars[r.calendar]=f),f.fullCalendar("addEventSource",t),o=!0)};s.onRemoved=function(n){f&&f.fullCalendar&&(f.fullCalendar("removeEventSource",n),o=!0)};s.onChanged=function(){f&&f.fullCalendar&&(f.fullCalendar("refetchEvents"),o=!0)};h.onAdded=function(n){f&&f.fullCalendar&&f.fullCalendar("renderEvent",n,!!n.stick)};h.onRemoved=function(n){f&&f.fullCalendar&&f.fullCalendar("removeEvents",n._id)};h.onChanged=function(n){var r,t,i;if(f&&f.fullCalendar)for(r=f.fullCalendar("clientEvents",n._id),t=0;t<r.length;t++)i=r[t],i=angular.extend(i,n),f.fullCalendar("updateEvent",i)};s.subscribe(t);h.subscribe(t,function(){if(o===!0)return o=!1,!1});t.$watch(l,function(n,i){n!==i?(t.destroyCalendar(),t.initCalendar()):n&&angular.isUndefined(f)&&t.initCalendar()})}}}]);