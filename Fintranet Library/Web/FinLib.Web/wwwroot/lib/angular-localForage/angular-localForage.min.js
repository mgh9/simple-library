/**
 * angular-localforage - Angular service & directive for https://github.com/mozilla/localForage (Offline storage, improved.)
 * @version v1.3.8
 * @link https://github.com/ocombe/angular-localForage
 * @license MIT
 * @author Olivier Combe <olivier.combe@gmail.com>
 */
(function(n,t){"use strict";var i=n&&n.angular||window&&window.angular;if(typeof define=="function"&&define.amd)define(["localforage"],function(n){return t(i,n)});else if(typeof exports=="object"||typeof global=="object")typeof module=="undefined"?global.module.exports=t(i,require("localforage")):module.exports=t(i,require("localforage"));else return t(i,n.localforage)})(this,function(n,t){"use strict";var i=n.module("LocalForageModule",["ng"]);return i.provider("$localForage",function(){var i={},r={name:"localforage"},f={setItem:!1,removeItem:!1},u={};this.setNotify=function(n,t){f={setItem:n,removeItem:t}};this.config=function(t){if(!n.isObject(t))throw new Error("The config parameter should be an object");n.extend(r,t)};this.$get=["$rootScope","$q","$parse",function(e,o,s){function l(t,i){return function(r){if((n.isObject(r)&&r.name?r.name==="InvalidStateError":n.isString(r)&&r==="InvalidStateError")&&this.driver()==="asyncStorage"||n.isObject(r)&&r.code&&r.code===5){var u=this;return u.setDriver("localStorageWrapper").then(function(){return i.apply(u,t)})}return o.reject(r)}}var h=function(i){n.isDefined(i)?this._localforage=t.createInstance(i):(this._localforage=t,t.config(r))},c;return h.prototype.createInstance=function(t){if(n.isObject(t)){if(t=n.extend({},r,t),n.isDefined(i[t.name]))throw new Error("A localForage instance with the name "+t.name+" is already defined.");return i[t.name]=new h(t),i[t.name]}throw new Error("The parameter should be a config object.");},h.prototype.instance=function(t){if(n.isUndefined(t))return i[r.name];if(n.isString(t)){if(n.isDefined(i[t]))return i[t];throw new Error("No localForage instance of that name exists.");}else throw new Error("The parameter should be a string.");},h.prototype.setDriver=function(n){return this._localforage.setDriver(n)},h.prototype.driver=function(){return this._localforage.driver()},h.prototype.defineDriver=function(n){return this._localforage.defineDriver(n)},h.prototype.setItem=function(t,i){function s(t){var i;return n.isArray(t)?t.map(s):n.isObject(t)&&t.constructor===Object?(i=n.extend({},t),n.isDefined(i.$promise)&&delete i.$promise,n.isDefined(i.$$hashKey)&&delete i.$$hashKey,Object.keys(i).reduce(function(n,t){return n[t]=s(i[t]),n},{})):t}if(n.isUndefined(t))throw new Error("You must define a key to set");var r=this,h=arguments,u;if(n.isArray(t)){if(!n.isArray(i))throw new Error("If you set an array of keys, the values should be an array too");return o.all(t.map(function(n,t){return r.setItem(n,i[t])}))}return u=s(i),r._localforage.setItem(r.prefix()+t,u).then(function(){return f.setItem&&e.$broadcast("LocalForageModule.setItem",{key:t,newvalue:u,driver:r.driver()}),u}).catch(l(h,r.setItem))},h.prototype.getItem=function(t,i){var r,s;if(n.isUndefined(t))throw new Error("You must define a key to get");var u=o.defer(),h=arguments,f=this,e;return n.isArray(t)?(r=[],s=0,e=f._localforage.iterate(function(n,i){var u=t.indexOf(f.prefix()+i);return u>-1&&(r[u]=n,s++),s===t.length?r:void 0}).then(function(){for(var e=!0,f=0;f<t.length;f++)n.isUndefined(r[f])&&(r[f]=null,e=!1);e||!i?u.resolve(r):u.reject(r)})):e=f._localforage.getItem(f.prefix()+t).then(function(n){i&&n===null?u.reject(n):u.resolve(n)}),e.then(null,function(n){f.onError(n,h,f.getItem,u)}),u.promise},h.prototype.iterate=function(t){if(n.isUndefined(t))throw new Error("You must define a callback to iterate");var i=o.defer(),u=arguments,r=this;return r._localforage.iterate(t).then(function(n){i.resolve(n)},function(n){r.onError(n,u,r.iterate,i)}),i.promise},h.prototype.removeItem=function(t){var i,u,r,s;if(n.isUndefined(t))throw new Error("You must define a key to remove");return i=this,n.isArray(t)?(u=[],n.forEach(t,function(n){u.push(i.removeItem(n))}),o.all(u)):(r=o.defer(),s=arguments,i._localforage.removeItem(i.prefix()+t).then(function(){f.removeItem&&e.$broadcast("LocalForageModule.removeItem",{key:t,driver:i.driver()});r.resolve()},function(n){i.onError(n,s,i.removeItem,r)}),r.promise)},h.prototype.pull=function(t){var i=this,r;if(n.isUndefined(t))throw new Error("You must define a key to pull");return i.getItem(t).then(function(n){return r=n,i.removeItem(t)}).then(function(){return r})},h.prototype.clear=function(){var n=o.defer(),i=arguments,t=this;return t._localforage.clear().then(function(){n.resolve()},function(r){t.onError(r,i,t.clear,n)}),n.promise},h.prototype.key=function(t){if(n.isUndefined(t))throw new Error("You must define a position to get for the key function");var i=o.defer(),u=arguments,r=this;return r._localforage.key(t).then(function(n){i.resolve(n)},function(n){r.onError(n,u,r.key,i)}),i.promise},c=function(){var t=o.defer(),i=arguments,n=this;return n._localforage.keys().then(function(i){var f,u,e;if(r.oldPrefix&&n.driver()==="localStorageWrapper"){for(f=[],u=0,e=i.length;u<e;u++)f.push(i[u].substr(n.prefix().length,i[u].length));i=f}t.resolve(i)},function(r){n.onError(r,i,n.keys,t)}),t.promise},h.prototype.keys=c,h.prototype.getKeys=c,h.prototype.length=function(){var n=o.defer(),i=arguments,t=this;return t._localforage.length().then(function(t){n.resolve(t)},function(r){t.onError(r,i,length,n)}),n.promise},h.prototype.bind=function(t,f){var c,e,o,h;if(n.isString(f))f={key:f};else if(!n.isObject(f)||n.isUndefined(f.key))throw new Error("You must define a key to bind");if(c={defaultValue:"",name:r.name},f=n.extend({},c,f),e=i[f.name],n.isUndefined(e))throw new Error("You must use the name of an existing instance");return o=f.scopeKey||f.key,h=s(o),e.getItem(f.key,!0).then(function(n){return h.assign(t,n),n}).catch(function(){return h.assign(t,f.defaultValue),e.setItem(f.key,f.defaultValue)}).then(function(i){return n.isDefined(u[f.key])&&u[f.key](),u[f.key]=t.$watch(o,function(t){n.isDefined(t)&&e.setItem(f.key,t)},!0),i})},h.prototype.unbind=function(t,f){var o,e;if(n.isString(f))f={key:f};else if(!n.isObject(f)||n.isUndefined(f.key))throw new Error("You must define a key to unbind");if(o={scopeKey:f.key,name:r.name},f=n.extend({},o,f),e=i[f.name],n.isUndefined(e))throw new Error("You must use the name of an existing instance");return s(f.scopeKey).assign(t,null),n.isDefined(u[f.key])&&(u[f.key](),delete u[f.key]),e.removeItem(f.key)},h.prototype.prefix=function(){return this.driver()==="localStorageWrapper"&&r.oldPrefix?this._localforage.config().name+".":""},h.prototype.onError=function(t,i,r,u){if((n.isObject(t)&&t.name?t.name==="InvalidStateError":n.isString(t)&&t==="InvalidStateError")&&this.driver()==="asyncStorage"||n.isObject(t)&&t.code&&t.code===5){var f=this;f.setDriver("localStorageWrapper").then(function(){r.apply(f,i).then(function(n){u.resolve(n)},function(n){u.reject(n)})},function(){u.reject(t)})}else u.reject(t)},i[r.name]=new h,i[r.name]}]}),i.directive("localForage",["$localForage",function(t){return{restrict:"A",link:function(i,r,u){var f=i.$eval(u.localForage);n.isObject(f)&&n.isDefined(f.key)?t.bind(i,f):t.bind(i,u.localForage)}}}]),i.name});